name: Deploy Backend

on:
  push:
    branches:
      - main
    paths:
      - 'apps/server/**'
      - 'packages/shared-types/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

concurrency:
  group: deploy-backend
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      types-changed: ${{ steps.changes.outputs.types }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "^apps/backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^packages/shared-types/"; then
            echo "types=true" >> $GITHUB_OUTPUT
          else
            echo "types=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    needs: detect-changes
    if: |
      github.event_name == 'workflow_dispatch' ||
      needs.detect-changes.outputs.backend-changed == 'true' ||
      needs.detect-changes.outputs.types-changed == 'true'
    environment: go_daddy
    runs-on: ubuntu-latest

    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      HOST: ${{ secrets.VPS_SERVER_IP }}
      REPO_URL: https://github.com/DiegoPevi05/bambucamp.git
      REMOTE_DIR: /home/bambucamp/bambucamp-backend
      SERVICE_NAME: bambucamp-backend

    steps:
      - name: Initialize Deploy
        env:
          SLACK_OK: "ðŸš€ Initialize deploy of *Bambucamp Backend* to Digital Ocean VPS"
        run: |
          set -euo pipefail
          echo "${SLACK_OK}"
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
            || { echo "Slack notify failed (init). Continuing..."; }

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create .env file
        env:
          SLACK_OK: "âœ… Created .env file"
          SLACK_ERR: "âŒ Failed creating .env file"
        run: |
          set -euo pipefail
          {
            echo ADMIN_HOSTNAME=${{ secrets.ADMIN_HOSTNAME }}
            echo ADMIN_HOSTNAME_2=${{ secrets.ADMIN_HOSTNAME_2 }}
            echo CLIENT_HOSTNAME=${{ secrets.CLIENT_HOSTNAME }}
            echo CLIENT_HOSTNAME_2=${{ secrets.CLIENT_HOSTNAME_2 }}
            echo DATABASE_URL="${{ secrets.DATABASE_URL }}"
            echo JWT_SECRET=${{ secrets.JWT_SECRET }}
            echo PORT=${{ secrets.PORT }}
            echo ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            echo ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            echo SMTP_HOST=${{ secrets.SMTP_HOST }}
            echo SMTP_PORT=${{ secrets.SMTP_PORT }}
            echo SMTP_USER=${{ secrets.SMTP_USER }}
            echo SMTP_PASS=${{ secrets.SMTP_PASS }}
          } >> .env \
          && curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
          || { curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_ERR}"'"}' "$SLACK_WEBHOOK_URL"; exit 1; }

      - name: Add host key to known hosts
        env:
          SLACK_OK: "âœ… SSH known_hosts configured for ${{ env.HOST }}"
          SLACK_ERR: "âŒ SSH known_hosts setup failed for ${{ env.HOST }}"
        run: |
          set -euo pipefail
          ssh-keyscan "$HOST" >> ~/.ssh/known_hosts \
          && curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
          || { curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_ERR}"'"}' "$SLACK_WEBHOOK_URL"; exit 1; }

      - name: Ensure repo directory and sync code
        env:
          SLACK_OK: "âœ… Repo directory ensured and code synced"
          SLACK_ERR: "âŒ Failed ensuring repo directory or syncing code"
        run: |
          set -euo pipefail
          ssh bambucamp@"$HOST" '
            set -euo pipefail
            mkdir -p "'"$REMOTE_DIR"'"
            if [ ! -d "'"$REMOTE_DIR/.git"'" ]; then
              git clone --sparse "'"$REPO_URL"'" "'"$REMOTE_DIR"'"
              cd "'"$REMOTE_DIR"'"
              git sparse-checkout set apps/server packages/shared-types
            else
              cd "'"$REMOTE_DIR"'"
              git fetch --all
              git reset --hard origin/main
            fi
          ' \
          && curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
          || { curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_ERR}"'"}' "$SLACK_WEBHOOK_URL"; exit 1; }

      - name: Ensure /public/images directory exists
        env:
          SLACK_OK: "âœ… Ensured /public/images exists on server"
          SLACK_ERR: "âŒ Failed creating /public/images on server"
        run: |
          set -euo pipefail
          ssh bambucamp@"$HOST" '
            set -euo pipefail
            mkdir -p "'"$REMOTE_DIR"'/apps/server/public/images"
          ' \
          && curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
          || { curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_ERR}"'"}' "$SLACK_WEBHOOK_URL"; exit 1; }

      - name: Upload .env to server
        env:
          SLACK_OK: "âœ… Uploaded .env to server"
          SLACK_ERR: "âŒ Failed uploading .env to server"
        run: |
          set -euo pipefail
          scp .env bambucamp@"$HOST":"$REMOTE_DIR"/apps/server/.env \
            && curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
            || { curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"'"${SLACK_ERR}"'"}' "$SLACK_WEBHOOK_URL"; exit 1; }

      - name: Install dependencies
        env:
          SLACK_OK: "âœ… Installing dependencies completed"
          SLACK_ERR: "âŒ Installing dependencies failed"
        run: |
          set -euo pipefail
          ssh bambucamp@"$HOST" '
            set -euo pipefail
            cd "'"$REMOTE_DIR/apps/server"'"
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
          ' \
          && curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
          || { curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_ERR}"'"}' "$SLACK_WEBHOOK_URL"; exit 1; }

      - name: Prisma migrate deploy
        env:
          SLACK_OK: "âœ… Prisma migrate deploy completed"
          SLACK_ERR: "âŒ Prisma migrate deploy failed"
        run: |
          set -euo pipefail
          ssh bambucamp@"$HOST" '
            set -euo pipefail
            cd "'"$REMOTE_DIR/apps/server"'"
            npx prisma generate
            npx prisma migrate deploy
          ' \
          && curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
          || { curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_ERR:"'"}' "$SLACK_WEBHOOK_URL"; exit 1; }

      - name: Build shared-types
        env:
          SLACK_OK: "âœ… Built shared-types package"
          SLACK_ERR: "âŒ Failed building shared-types"
        run: |
          set -euo pipefail
          ssh bambucamp@"$HOST" '
            set -euo pipefail
            cd "'"$REMOTE_DIR/packages/shared-types"'"
            npx tsc
          ' \
          && curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
          || { curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"'"${SLACK_ERR}"'"}' "$SLACK_WEBHOOK_URL"; exit 1; }

      - name: Restart backend service
        env:
          SLACK_OK: "âœ… Restarted ${{ env.SERVICE_NAME }} service"
          SLACK_ERR: "âŒ Failed restarting ${{ env.SERVICE_NAME }} service"
        run: |
          set -euo pipefail
          ssh bambucamp@"$HOST" '
            set -euo pipefail
            sudo systemctl daemon-reload || true
            sudo systemctl restart "'"$SERVICE_NAME"'"
            sudo systemctl is-active "'"$SERVICE_NAME"'" >/dev/null
            sudo systemctl status "'"$SERVICE_NAME"'" --no-pager || true
          ' \
          && curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
          || { curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_ERR}"'"}' "$SLACK_WEBHOOK_URL"; exit 1; }

      - name: Done
        env:
          SLACK_OK: "ðŸŽ‰ Backend App Deployed Successfully :nodejs:"
        run: |
          set -euo pipefail
          echo "${SLACK_OK}"
          curl -X POST -H 'Content-type: application/json' --data '{"text":"'"${SLACK_OK}"'"}' "$SLACK_WEBHOOK_URL" \
            || { echo "Slack notify failed (done). Continuing..."; }

      - name: Notify final failure
        if: ${{ failure() }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ðŸš¨ *Backend Deployment failed* â€” check the step above for the exact error."}' "$SLACK_WEBHOOK_URL"
